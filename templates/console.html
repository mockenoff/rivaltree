{% extends "base.html" %}
{% load staticfiles %}

{% block title %}WebSocket Debug console - {% endblock %}
{% block meta_description %}Admin debug console for WebSocket stuff{% endblock %}

{% block container_class %}console{% endblock %}

{% block scripts %}
<script>
if(window.__rivaltree === undefined) {
	!function(doc, win){
		window.__rivaltree = {
			ev:(doc.addEventListener !== undefined ? {
				add: 'addEventListener',
				rem: 'removeEventListener',
				pre: ''
			}:{
				add: 'attachEvent',
				rem: 'detachEvent',
				pre: 'on'
			}),
			ajax:{
				isIE8:(win.XDomainRequest !== undefined ? true : false),
				IEVersion:(function(){
					var a = navigator.userAgent.toLowerCase();
					return a.indexOf('msie') !== -1 ? parseInt(a.split('msie')[1],10) : false;
				})(),
				get:function(url, data, callback){
					var xhr = (__rivaltree.ajax.isIE8 === true ? new win.XDomainRequest() : new XMLHttpRequest()),
						handler = function(e){
							if(xhr.readyState === 4 && xhr.status === 200) {
								response();
							}
						},
						response = function(){
							if(typeof(callback) === 'function') {
								callback(data, xhr.responseText);
							}
						};
					try {
						if(__rivaltree.ajax.isIE8 === true) {
							xhr.onload = response;
							xhr.open('GET', url, true);
							xhr.onprogress = function(){};
							xhr.ontimeout = function(){};
							xhr.onerror = function(){};
							setTimeout(function(){xhr.send();}, 0);
						}
						else {
							xhr.open('GET', url, true);
							xhr.onreadystatechange = handler;
							xhr.send();
						}
					}
					catch(e){
						console.log(e);
					}
				}
			},
			getElementsByClassName:function(c, s){
				if(s === undefined) {
					s = doc;
				}
				return doc.getElementsByClassName !== undefined ? s.getElementsByClassName(c) : s.querySelectorAll('.'+c);
			},
			classFactor:function(e, c){
				var s = e.className.split(' '),
					r = [];
				c = c.toLowerCase();
				for(var i = 0; i < s.length; i++) {
					if(s[i] !== '' && s[i].toLowerCase() !== c) {
						r.push(s[i]);
					}
				}
				return r;
			},
			addClass:function(e, c){
				var r = __rivaltree.classFactor(e, c);
				r.push(c);
				e.className = r.join(' ');
				return e.className;
			},
			removeClass:function(e, c) {
				var r = __rivaltree.classFactor(e, c);
				e.className = r.join(' ');
				return e.className;
			},
			hasClass:function(e, c) {
				return RegExp('^(\\s*.+\\s+)*'+c+'(\\s+.+\\s*)*$', 'i').test(e.className);
			},
			camelize:function(s){
				return s.replace(/[\-\s_](\w)/g, function(d, l){
					return l.toUpperCase();
				});
			},
			getStyle:function(e, s){
				var c = __rivaltree.camelize(s);
				if(e.style[c] !== '') {
					return e.style[c];
				}
				if(e.currentStyle === undefined) {
					return doc.defaultView.getComputedStyle(e, null).getPropertyValue(s);
				}
				return e.currentStyle(c);
			},
			WebSocket:function(url, options) {
				var op = {
						reconnect: true,
						reconnectAttempts: 5,
						reconnectInterval: 3000,
					},
					rc = {
						attempts: 0,
						interval: null,
					},
					ws = new WebSocket(url);

				if (typeof options === 'object') {
					for (var key in options) {
						if (key in op === true) {
							op[key] = options[key];
						}
					}
				}

				function reconnect() {
					if (rc.attempts < op.reconnectAttempts) {
addLog('Reconnect attempt #' + rc.attempts);
						rc.attempts++;
						rc.interval = setTimeout(reconnect, op.reconnectInterval);
					}
				}

				ws.onopen = function() {
addLog('websocket connected');
					if (rc.interval !== null) {
						clearTimeout(rc.interval);
						rc.interval = null;
					}
					if ('onopen' in op === true && typeof op.onopen === 'function') {
						op.onopen();
					}
				};
				ws.onmessage = function(e) {
addLog('Received: ' + e.data);
					if ('onmessage' in op === true && typeof op.onmessage === 'function') {
						op.onmessage(e.data);
					}
				};
				ws.onerror = function(e) {
addLog('Error: '+e);
					if ('onerror' in op === true && typeof op.onerror === 'function') {
						op.onerror(e);
					}
				};
				ws.onclose = function(e) {
addLog('connection closed');
					if (op.reconnect === true) {
						rc.attempts = 0;
						reconnect();
					}
					if ('onclose' in op === true && typeof op.onclose === 'function') {
						op.onclose(e);
					}
				}
				this.sendMessage = function(msg) {
addLog('Send: ' + msg.substr(0, 100) + '...');
					ws.send(msg);
				};
			},
			isMobile:(function() {
				var a = navigator.userAgent || navigator.vendor || win.opera;
				return /(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4));
			})(),
		};
	}(document, window);
}

var ws = new __rivaltree.WebSocket('{{ ws_url }}');

var log = document.querySelector('#log');
function addLog(message) {
	var li = document.createElement('li');
	li.innerText = '> '+message;
	if (log.children.length < 1) {
		log.appendChild(li);
	} else {
		log.insertBefore(li, log.children[0]);
	}
	console.log(message);
}

var form = document.querySelector('#form'),
	text = form.querySelector('textarea');

form.addEventListener('submit', function(e) {
	e.preventDefault();
	if (text.value !== '') {
		ws.sendMessage(text.value);
	}
});
</script>
{% endblock %}

{% block styles %}
<style>
	#log {
		height: 200px;
		background: #FFF;
		overflow-y: scroll;
		border-radius: 3px;
		border: 1px solid #DDD;
	}
	textarea {
		height: 200px;
	}
</style>
{% endblock %}

{% block container %}
<section class="cap-wrapper">
	<h1>WebSocket Console</h1>
	<ul id="log"></ul>
	<form id="form">
		<textarea>{"type":"PUB","bracket_id":"7f94097c3ca8415ab209fe6c1c063b07","bracket":{"seeds":{"1":"513bc90d762b4cc69c1221e6993acbbd","2":"aa1c23817dd3475db23864491972c802","3":"334469d886ee4b388f1abba32e096f3b","4":"cce6b5cb4c2749b081c915fd95d09f62","5":"ec1c3ac80ddc40e983365e9c5c83b87a"},"round_robin":[[{"team2":{"wins":0,"id":"cce6b5cb4c2749b081c915fd95d09f62","seed":null},"loser_to":null,"id":"b641f09bcbe54fb0bfd252754309d3cd","winner_to":null,"team1":{"wins":0,"id":"513bc90d762b4cc69c1221e6993acbbd","seed":null}},{"team2":{"wins":0,"id":"ec1c3ac80ddc40e983365e9c5c83b87a","seed":null},"loser_to":null,"id":"c24fe541bbfe44f8ae01cbc27178e5c2","winner_to":null,"team1":{"wins":0,"id":"334469d886ee4b388f1abba32e096f3b","seed":null}}],[{"team2":{"wins":0,"id":"aa1c23817dd3475db23864491972c802","seed":null},"loser_to":null,"id":"6c5fc1dda4cd45fea39e69ff99b0ace4","winner_to":null,"team1":{"wins":0,"id":"334469d886ee4b388f1abba32e096f3b","seed":null}},{"team2":{"wins":0,"id":"cce6b5cb4c2749b081c915fd95d09f62","seed":null},"loser_to":null,"id":"76269c916e13435bbb37dfaa6e746bec","winner_to":null,"team1":{"wins":0,"id":"ec1c3ac80ddc40e983365e9c5c83b87a","seed":null}}],[{"team2":{"wins":0,"id":"513bc90d762b4cc69c1221e6993acbbd","seed":null},"loser_to":null,"id":"fe662677287041a8b6c8185a9bf707c6","winner_to":null,"team1":{"wins":0,"id":"ec1c3ac80ddc40e983365e9c5c83b87a","seed":null}},{"team2":{"wins":0,"id":"aa1c23817dd3475db23864491972c802","seed":null},"loser_to":null,"id":"362e129c7a07427ba2d1057453ede71e","winner_to":null,"team1":{"wins":0,"id":"cce6b5cb4c2749b081c915fd95d09f62","seed":null}}],[{"team2":{"wins":0,"id":"334469d886ee4b388f1abba32e096f3b","seed":null},"loser_to":null,"id":"35a189746c6c42418ee56b134b1885ba","winner_to":null,"team1":{"wins":0,"id":"cce6b5cb4c2749b081c915fd95d09f62","seed":null}},{"team2":{"wins":0,"id":"513bc90d762b4cc69c1221e6993acbbd","seed":null},"loser_to":null,"id":"3e9a260921654d188e45658f17525c0b","winner_to":null,"team1":{"wins":0,"id":"aa1c23817dd3475db23864491972c802","seed":null}}],[{"team2":{"wins":0,"id":"ec1c3ac80ddc40e983365e9c5c83b87a","seed":null},"loser_to":null,"id":"9272e8d4e7cb44daad511f7a55132f04","winner_to":null,"team1":{"wins":0,"id":"aa1c23817dd3475db23864491972c802","seed":null}},{"team2":{"wins":0,"id":"334469d886ee4b388f1abba32e096f3b","seed":null},"loser_to":null,"id":"aaba61027a314c0494b91557560bc2db","winner_to":null,"team1":{"wins":0,"id":"513bc90d762b4cc69c1221e6993acbbd","seed":null}}]],"views":0,"losers":[[{"team2":{"wins":0,"id":null,"seed":3},"loser_to":null,"id":"1589df20c40e4895bd9982bf65b0ea9e","winner_to":"77700cd75fbe4497ad414738bb553f8d","team1":{"wins":0,"id":null,"seed":2}}],[{"team2":{"wins":0,"id":null,"seed":4},"loser_to":null,"id":"4ce46e4b9690463c8d694711c0171f67","winner_to":"1589df20c40e4895bd9982bf65b0ea9e","team1":{"wins":0,"id":null,"seed":3}}],[{"team2":{"wins":0,"id":null,"seed":5},"loser_to":null,"id":"e97032f38ba8433d9793be252d0c404f","winner_to":"4ce46e4b9690463c8d694711c0171f67","team1":{"wins":0,"id":null,"seed":4}}]],"winner_loser":[[{"team2":{"wins":0,"id":null,"seed":2},"loser_to":null,"id":"680799dbba42414aa475e743dfd82a75","winner_to":null,"team1":{"wins":0,"id":null,"seed":1}}],[{"team2":{"wins":0,"id":null,"seed":2},"loser_to":"680799dbba42414aa475e743dfd82a75","id":"77700cd75fbe4497ad414738bb553f8d","winner_to":"680799dbba42414aa475e743dfd82a75","team1":{"wins":0,"id":null,"seed":1}}]],"date_created":"2016-02-12T03:39:02.727Z","has_round_robin":true,"is_randomized":false,"datetime":"2016-02-12T03:38:58Z","id":"7f94097c3ca8415ab209fe6c1c063b07","is_double_elimination":true,"title":"Test Bracket","phase":[3,"Bracket"],"has_third_place":false,"teams":{"334469d886ee4b388f1abba32e096f3b":{"header_path":"","name":"Team C","seed":null},"aa1c23817dd3475db23864491972c802":{"header_path":"","name":"Team E","seed":null},"cce6b5cb4c2749b081c915fd95d09f62":{"header_path":"","name":"Team B","seed":null},"ec1c3ac80ddc40e983365e9c5c83b87a":{"header_path":"","name":"Team A","seed":null},"513bc90d762b4cc69c1221e6993acbbd":{"header_path":"","name":"Team D","seed":null}},"winners":[[{"team2":{"wins":0,"id":null,"seed":2},"loser_to":"1589df20c40e4895bd9982bf65b0ea9e","id":"811b61bc20fa49a5ac91626422052885","winner_to":"77700cd75fbe4497ad414738bb553f8d","team1":{"wins":0,"id":null,"seed":1}}],[{"team2":{"wins":0,"id":null,"seed":4},"loser_to":"e97032f38ba8433d9793be252d0c404f","id":"8a3bcadab651493c9e64050017027c69","winner_to":"811b61bc20fa49a5ac91626422052885","team1":{"wins":0,"id":null,"seed":1}},{"team2":{"wins":0,"id":null,"seed":3},"loser_to":"4ce46e4b9690463c8d694711c0171f67","id":"7fb2432597044223823730c7b523d54f","winner_to":"811b61bc20fa49a5ac91626422052885","team1":{"wins":0,"id":null,"seed":2}}],[{"team2":{"wins":0,"id":null,"seed":5},"loser_to":"e97032f38ba8433d9793be252d0c404f","id":"18c7f9f4661341bf87ebeb2e24a97d92","winner_to":"8a3bcadab651493c9e64050017027c69","team1":{"wins":0,"id":null,"seed":4}}]],"date_updated":"2016-02-12T03:40:09.352Z"}}</textarea>
		<input class="btn btn-action" type="submit" value="Send" />
	</form>
</section>
{% endblock %}
